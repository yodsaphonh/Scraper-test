<!DOCTYPE html>
<html lang="th" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Scopus Metrics Scraper</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Inter:wght@400;600;700&display=swap" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body class="theme-dark">
    <div class="background-glow"></div>
    <main class="layout">
      <header class="hero">
        <div>
          <p class="eyebrow">Web Scraper</p>
          <h1>Scopus Journal Insight</h1>
          <p class="lead">
            ‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ISSN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CiteScore, SJR ‡πÅ‡∏•‡∏∞ SNIP ‡∏à‡∏≤‡∏Å Scopus ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á Quartile
            (Q1-Q4) ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </p>
        </div>
        <button id="theme-toggle" type="button" aria-label="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°" class="theme-toggle">
          <span class="toggle-icon" aria-hidden="true">üåô</span>
          <span class="toggle-label">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
        </button>
      </header>

      <section class="card">
        <form id="scrape-form" class="scrape-form">
          <div class="field-group">
            <label for="issn-input">ISSN</label>
            <div class="input-wrapper">
              <span class="input-prefix">ISSN</span>
              <input
                type="text"
                id="issn-input"
                name="issn"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 1234-5678"
                autocomplete="off"
                required
              />
            </div>
            <p class="field-hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏Ç‡∏µ‡∏î (-) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏µ‡∏î</p>
          </div>

          <details class="advanced">
            <summary>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</summary>
            <div class="advanced-grid">
              <label for="cookie-input">Cookie ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Scopus (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <textarea
                id="cookie-input"
                name="cookie"
                rows="2"
                placeholder="‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Cookie Header ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Scopus ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô"
              >{{ default_cookie }}</textarea>
              <p class="field-hint">
                ‡∏ö‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Scopus ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤ Cookie ‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
              </p>
              <label class="switch">
                <input type="checkbox" id="headless-toggle" name="headless" {% if headless %}checked{% endif %} />
                <span>‡∏£‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏à‡∏≠ (Headless)</span>
              </label>
            </div>
          </details>

          <button type="submit" class="submit-button">
            <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path
                d="M5 12h14M13 5l7 7-7 7"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
            </svg>
          </button>
        </form>
        <div id="form-status" class="status" role="status" aria-live="polite"></div>
      </section>

      <section class="results" id="results">
        <div class="placeholder">
          <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
            <path
              d="M10 50h44M10 36h44M10 22h44M16 8h32"
              stroke="currentColor"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
              fill="none"
              opacity="0.4"
            ></path>
          </svg>
          <p>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
        </div>
      </section>
    </main>

    <template id="result-template">
      <article class="result-card">
        <header class="result-header">
          <div>
            <p class="result-issn">ISSN {{ISSN}}</p>
            <h2>{{TITLE}}</h2>
          </div>
          <a class="result-link" href="{{URL}}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Scopus</a>
        </header>
        <div class="metric-grid">
          <div class="metric">
            <p class="metric-label">CiteScore</p>
            <p class="metric-value">{{CITESCORE}}</p>
          </div>
          <div class="metric">
            <p class="metric-label">SJR</p>
            <p class="metric-value">{{SJR}}</p>
          </div>
          <div class="metric">
            <p class="metric-label">SNIP</p>
            <p class="metric-value">{{SNIP}}</p>
          </div>
        </div>
        <section class="quartile-section">
          <h3>Quartile ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h3>
          <ul class="quartile-list">{{QUARTILES}}</ul>
        </section>
      </article>
    </template>

    <template id="quartile-item-template">
      <li class="quartile-item">
        <span class="badge">{{Q}}</span>
        <span class="subject">{{SUBJECT}}</span>
      </li>
    </template>

    <div id="overlay-loader" class="overlay" hidden>
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <script>
      const API_ENDPOINT = "{{ url_for('scrape_metrics') }}";
      const body = document.body;
      const themeToggle = document.getElementById('theme-toggle');
      const storedTheme = localStorage.getItem('theme-preference');
      const defaultTheme = body.classList.contains('theme-light') ? 'light' : 'dark';
      const applyTheme = (theme) => {
        body.classList.remove('theme-dark', 'theme-light');
        body.classList.add(`theme-${theme}`);
        localStorage.setItem('theme-preference', theme);
        themeToggle.querySelector('.toggle-icon').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        themeToggle.querySelector('.toggle-label').textContent = theme === 'dark' ? '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î' : '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
      };

      applyTheme(storedTheme || defaultTheme);

      themeToggle.addEventListener('click', () => {
        const nextTheme = body.classList.contains('theme-dark') ? 'light' : 'dark';
        applyTheme(nextTheme);
      });

      const form = document.getElementById('scrape-form');
      const overlay = document.getElementById('overlay-loader');
      const statusElement = document.getElementById('form-status');
      const resultSection = document.getElementById('results');
      const resultTemplate = document.getElementById('result-template').innerHTML;
      const quartileTemplate = document.getElementById('quartile-item-template').innerHTML;

      const setStatus = (message, variant = 'info') => {
        statusElement.textContent = message || '';
        statusElement.dataset.variant = message ? variant : '';
      };

      const renderQuartiles = (quartiles) => {
        if (!Array.isArray(quartiles) || quartiles.length === 0) {
          return '<li class="quartile-item empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Quartile</li>';
        }
        return quartiles
          .map((item) => {
            const subject = (item.subject || item.Subject || '').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤';
            const quartile = (item.quartile || item.Quartile || '').trim() || '-';
            return quartileTemplate
              .replace('{{SUBJECT}}', subject)
              .replace('{{Q}}', quartile);
          })
          .join('');
      };

      const renderResult = (data) => {
        const html = resultTemplate
          .replace('{{ISSN}}', data.issn || '-')
          .replace('{{TITLE}}', data.title || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£')
          .replace('{{URL}}', data.sourceUrl || '#')
          .replace('{{CITESCORE}}', data.citeScore || '-')
          .replace('{{SJR}}', data.sjr || '-')
          .replace('{{SNIP}}', data.snip || '-')
          .replace('{{QUARTILES}}', renderQuartiles(data.quartiles));
        resultSection.innerHTML = html;
      };

      const toggleOverlay = (show) => {
        if (show) {
          overlay.removeAttribute('hidden');
          overlay.setAttribute('aria-hidden', 'false');
          overlay.classList.add('is-visible');
        } else {
          overlay.setAttribute('hidden', '');
          overlay.setAttribute('aria-hidden', 'true');
          overlay.classList.remove('is-visible');
        }
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const issnInput = document.getElementById('issn-input');
        const cookieInput = document.getElementById('cookie-input');
        const headlessToggle = document.getElementById('headless-toggle');

        const payload = {
          issn: issnInput.value,
          cookie: cookieInput.value,
          headless: headlessToggle.checked,
        };

        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
        toggleOverlay(true);
        const abortController = new AbortController();
        const timeoutId = setTimeout(() => abortController.abort(), 60000);
        try {
          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
            signal: abortController.signal,
          });
          const result = await response.json();
          if (!response.ok || !result.success) {
            const errorMessage = result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
            setStatus(errorMessage, 'error');
            return;
          }
          renderResult(result.data || {});
          setStatus('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } catch (error) {
          console.error(error);
          if (error.name === 'AbortError') {
            setStatus('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          } else {
            setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
          }
        } finally {
          clearTimeout(timeoutId);
          toggleOverlay(false);
        }
      });
    </script>
  </body>
</html>
